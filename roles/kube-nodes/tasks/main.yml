- name: Check Docker
  shell: >
    systemctl is-active docker || echo "not running"
  register: docker_already_running

- name: Set container_manager_detected configure
  set_fact:
    container_manager_detected: >-
      {%- if docker_already_running.stdout == "active" -%}
      docker
      {%- else -%}
      containerd
      {%- endif -%}

- name: 创建 kubernetes 相关目录
  file: 
    name: "{{ item }}"
    state: directory
  with_items:
  - "{{ kubelet_root_dir }}"
  - /etc/kubernetes
  - /usr/share/bash-completion/completions

- name: 读取 kubelet.conf 文件 stat 信息
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_stat

# - include_tasks: "{{ (role_path + '/../kube-master/tasks/kubeadm-config.yml') | realpath  }}"
#- name: Copy kubeconfig to user's home
  # copy:
    #    src: /etc/kubernetes/kubeadm_join.sh
      #    dest: /etc/kubernetes/kubeadm_join.sh
      #    remote_src: yes
- name: 分发添加节点脚本
  copy: src=/etc/kubernetes/kubeadm_join.sh dest=/etc/kubernetes mode=0755

- block:
  - name: 确认 kubelet 已停止运行
    service:
      name: kubelet
      state: stopped
      enabled: yes

  - name: Worker 节点加入集群
    shell: >
      bash -x /etc/kubernetes/kubeadm_join.sh
    ignore_errors: no
  when: 
  - not kubelet_conf_stat.stat.exists


